<!doctype html>
<html>
  <head>
  <style>
    body {
      text-align: center;
      background: purple;
      background-position: center;
      border: 20px;
      border-color: white;
    }
    h1 {
      color: white;
    }
    p {
      color: white;
      font-size: 20px;
    }
  </style>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript"></script>
    <script src="js/p5.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.0.19/firebase.js"></script>

    <script>

// var x = 0;
// var y = 0;
var velx = 3;
var vely = 3;
var LEFT_ARROW= 65;
var RIGHT_ARROW = 68;
var UP_ARROW = 87;
var DOWN_ARROW = 83;
var leftPress =false;
var rightPress = false;
var upPress = false;
var downPress =  false;
var rotateCW = false;
var rotateCCW = false;
var spacePress = false;
var controlPress1 = false;
var controlPress2 = false;
var controlPress3 = false;
var controlPress4 = false;
var cwPress  = false;
var ccwPress=  false;
var rotation = 0;
var myDataRef2;
var shipdata1Base;
var shipdata2Base;
var shipChoose;
var Ship1;
var Ship2;
var Ship3;
var Ship4;
var Shot;
var isControl = false;
var databaseControl;
var shipControl = 0;
var shipDic;
var shotIs = false;
var shots = [];
//float angle = 0;

// var isChanged;

myDataRef2 = new Firebase("https://luminous-fire-510.firebaseio.com/luiserebii");


function setup () {
 // shipChoose = new Firebase("https://luminous-fire-510.firebaseio.com");
  //shipChoose.set({ship1: false, ship2: false,ship3:false,ship4:false});
  createCanvas(800, 600);
  background(51);
  img = loadImage("http://i.imgur.com/0sNYCgg.png");

  Ship1 = new Ship(130, 175, 158, 120, 186, 175, 3, 3, "shipdata1", 0, 1);
  Ship2 = new Ship(200, 300, 300, 500, 700, 300, 6, 6, "shipdata2", 0, 2);


  myDataRef2.set({
    shipdata1: {
      x1: Ship1.x1,
      y1: Ship1.y1,
      x2: Ship1.x2,
      y2: Ship1.y2,
      x3: Ship1.x3,
      y3: Ship1.y3,
      isControl: false,
      rotation: Ship1.rotation
    }//,
    // shipdata2: {
    //   x1: Ship2.x1,
    //   y1: Ship2.y1,
    //   x2: Ship2.x2,
    //   y2: Ship2.y2,
    //   x3: Ship2.x3,
    //   y3: Ship2.y3,
    //   isControl: false,
    //   rotation: Ship2.rotation
    // }
  });

}


  //Creating Ship Class
  var Ship = function(x1, y1, x2, y2, x3, y3, velx, vely, shipdata, rotation, shipNum) {
    this.x1 = x1;
    this.y1 = y1;
    this.x2 = x2;
    this.y2 = y2;
    this.x3 = x3;
    this.y3 = y3;
    this.rotation = rotation;
    this.velx = velx;
    this.vely = vely;
    this.shipdata = shipdata;
    this.shipNum = shipNum;

    this.database = new Firebase("https://luminous-fire-510.firebaseio.com/luis/" + shipdata);

    var shipProperties = {
      x1: this.x1,
      y1: this.y1,
      x2: this.x2,
      y2: this.y2,
      x3: this.x3,
      y3: this.y3,
      isControl: false,
      rotation: this.rotation

    };

    this.database.set(
      shipProperties
    );

  }
  //Moving Ship Across The Screen
  Ship.prototype.move = function() {
      if(leftPress === true && this.x1>=0) {
        this.x1-=this.velx;
        this.x2-=this.velx;
        this.x3-=this.velx;
        console.log("move left!");
      }
      if (rightPress === true && this.x1<=670) {
        this.x1+=this.velx;
        this.x2+=this.velx;
        this.x3+=this.velx;
        console.log("Ship1: " + Ship1.x + "Ship2: " + Ship2.x + "this.x " + this.x);
      }
      if(upPress === true && this.y3>=0) {
        this.y1-=this.vely;
        this.y2-=this.vely;
        this.y3-=this.vely;
      }
      if (downPress === true && this.y3<=475){
        this.y1+=this.vely;
        this.y2+=this.vely;
        this.y3+=this.vely;
      }
      // if (spacePress === true) {
      //   angle-= 0.3
      // }
      if(rotateCW === true){
        this.rotation+=2;
      }
      if(rotateCCW === true){
        this.rotation-=2;
      }


      myDataRef2.child(this.shipdata).set({
        //shipdata1: {
          x1: this.x1,
          y1: this.y1,
          x2: this.x2,
          y2: this.y2,
          x3: this.x3,
          y3: this.y3,
          isControl: true,
          rotation: this.rotation          
        //}
      });

  }
  //Painting ship onto the canvas
  Ship.prototype.paint = function() {
      //The image size is (128,128)
    translate(this.velx,this.vely);

    rotate(this.rotation*TWO_PI/360);

    translate(-64,-64);
    triangle(this.x1, this.y1, this.x2, this.y2, this.x3, this.y3);
    
      //console.log("Painting " + this.shipdata + "at " + this.x + " " + this.y);
      // console.log("the rotation is"+this.rotation);
  }

    /*
    If the ship is false set ship true and creating that ship.
    if (ship1 = false){
      shipChoose.set({ship1: true});
      ship1 = true;
    }
    */

Ship.prototype.checkControl = function(controlPress) {
  var ship = this;
  
  myDataRef2.once('value', function(data){
    var snapshot = data.val();
    databaseControl = snapshot[ship.shipdata].isControl;
  });

  //console.log(databaseControl);
  if(controlPress == true && databaseControl == false && shipControl == 0){

    myDataRef2.child(this.shipdata).set({ 

        x1: this.x1,
        y1: this.y1,
        x2: this.x2,
        y2: this.y2,
        x3: this.x3,
        y3: this.y3,
        isControl: true,
        rotation: this.rotation        

    });
    shipControl = this.shipNum;    
    console.log("STATEMENT REACHED!!! UPDATE SUCCESS");
  }

}

var Shot = function(x, y, r, xSpd, ySpd){

  this.x = x;
  this.y = y;
  this.r = r;
  this.xSpd = xSpd;
  this.ySpd = ySpd;

}

Shot.prototype.move = function(){
  if(this.y < 1000){

    this.y = this.y - this.ySpd;

  }
}

Shot.prototype.paint = function(){
  ellipse(this.x, this.y, this.r, this.r);
}

Shot.prototype.nullShip = function(){
  
  if(this.y <= -10){
    shotIs = false;    
    shots[shots.length - 1] = null;
  }
}


//Checking if reading from the database(control).



//
function draw(){
  //Calling functions to redraw
  clear();
  background(51);

  Ship1.paint();
  //Ship2.paint();
  

  if(shipControl == 1){
    console.log("Moving ship 1");
    Ship1.move();

 
  }
  if(shipControl == 2 & shipControl != 0){
    console.log("Moving ship 2");

    Ship2.move();

    myDataRef2.child("shipdata1").on('value', function (snapshot){
      var datasnap = snapshot.val();
      Ship1.x1 = datasnap.x1;
      Ship1.y1 = datasnap.y1;
      Ship1.y2 = datasnap.y2;
      Ship1.y2 = datasnap.y2;
      Ship1.y3 = datasnap.y3;
      Ship1.y3 = datasnap.y3;
      // Ship1.rotation = datasnap.rotation;
    });
  }

  Ship1.checkControl(controlPress1); 
  //Ship2.checkControl(controlPress2);
  // checkControl1();
  // checkControl2();

  if(spacePress == true && shotIs == false){

    shots[shots.length] = new Shot(Ship1.x1 + 64, Ship1.y1, 10, 5, 5);    

    //debugger
    shotIs = true;
  }
  if(shotIs == true){

    shots[shots.length - 1].move();
    shots[shots.length - 1].paint();
    shots[shots.length - 1].nullShip();    //add shotIs false to nullShip
  }
}



//Key Presses 
$(document).keydown(function (evt) {
  //A Key
  if(evt.keyCode === 65){
    leftPress= true;
  }
  //W Key
  else if(evt.keyCode ===87 ){
    upPress = true;
  }
  //D Key
  else if(evt.keyCode === 68){
    rightPress = true;
  }
  //S Key
  else if (evt.keyCode=== 83){
    downPress = true;
  }
  //Spacebar
  else if (evt.keyCode ===32){
    spacePress = true;
  }
  //Num 1
  else if (evt.keyCode === 49){
    controlPress1 = true;
  }
  //Num 2
  else if (evt.keyCode === 50){
    controlPress2 = true;
  }
  //Num 3
  else if (evt.keyCode === 51){
    controlPress3 = true;
  }
  //Num 4
  else if (evt.keyCode === 52){
    controlPress4 = true;
  }      
  //Left Arrow
  else if (evt.keyCode === 39){
    rotateCCW = true;
  }      
  //Right Arrow
  else if (evt.keyCode === 37){
   rotateCW = true;
 }

});

$(document).keyup(function (evt) { 
  
  if(evt.keyCode === 65){
    leftPress= false;
  }
  else if(evt.keyCode ===87 ){
    upPress = false;
  }
  else if(evt.keyCode === 68){
    rightPress = false;
  }
  else if (evt.keyCode=== 83){
    downPress = false;
  }
  else if (evt.keyCode === 32){ 
    spacePress = false;
  }
  else if (evt.keyCode === 49){
    controlPress1 = false;
  }
  else if (evt.keyCode === 50){
    controlPress2 = false;
  }
  else if (evt.keyCode === 51){
    controlPress3 = false;
  }
  else if (evt.keyCode === 52){
    controlPress4 = false;
  }   
  else if (evt.keyCode === 39){
    rotateCCW = false;
  }      
  else if (evt.keyCode === 37){
   rotateCW = false;
  }
  });
    </script> 
  </head>
  <body>
    <h1> My Project!</h1>
    <p> Please Don't Do anything or i will kill your family</p>
  </body>
</html>
